name: Release Build v2

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

env:
  CARGO_TERM_COLOR: always

jobs:
  # Step 1: Create Release first
  prepare-release:
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.version.outputs.tag }}
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Extract version
        id: version
        shell: bash
        run: |
          if [[ "${{ github.ref_type }}" == "tag" ]]; then
            TAG="${{ github.ref_name }}"
            VERSION="${TAG#v}"
          else
            VERSION=$(node -p "require('./src-tauri/tauri.conf.json').version")
            TAG="v$VERSION"
          fi
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: "Antigravity Agent ${{ steps.version.outputs.tag }}"
          body: |
            ## ğŸ“¥ Download

            ### Windows
            - **Installer** (Recommended): [Antigravity.Agent_${{ steps.version.outputs.version }}_x64-setup.exe](${{ github.server_url }}/${{ github.repository }}/releases/download/${{ steps.version.outputs.tag }}/Antigravity.Agent_${{ steps.version.outputs.version }}_x64-setup.exe) - Supports auto-update
            - **Portable**: [Antigravity-Agent-x86_64-Portable.zip](${{ github.server_url }}/${{ github.repository }}/releases/download/${{ steps.version.outputs.tag }}/Antigravity-Agent-x86_64-Portable.zip) - Extract and run, no installation required

            ### macOS
            - **Apple Silicon (M1/M2)**: [Antigravity.Agent_${{ steps.version.outputs.version }}_aarch64.dmg](${{ github.server_url }}/${{ github.repository }}/releases/download/${{ steps.version.outputs.tag }}/Antigravity.Agent_${{ steps.version.outputs.version }}_aarch64.dmg)
            - **Intel Mac**: [Antigravity.Agent_${{ steps.version.outputs.version }}_x86_64.dmg](${{ github.server_url }}/${{ github.repository }}/releases/download/${{ steps.version.outputs.tag }}/Antigravity.Agent_${{ steps.version.outputs.version }}_x86_64.dmg)

            ### Linux
            - **AppImage**: [antigravity-agent_${{ steps.version.outputs.version }}_amd64.AppImage](${{ github.server_url }}/${{ github.repository }}/releases/download/${{ steps.version.outputs.tag }}/antigravity-agent_${{ steps.version.outputs.version }}_amd64.AppImage) - Universal format, works on all distros
            - **Debian/Ubuntu**: [antigravity-agent_${{ steps.version.outputs.version }}_amd64.deb](${{ github.server_url }}/${{ github.repository }}/releases/download/${{ steps.version.outputs.tag }}/antigravity-agent_${{ steps.version.outputs.version }}_amd64.deb)
            ---

            ## ğŸ“‹ Changelog

            ${{ github.event.release.body || format('See [commit history](https://github.com/{0}/commits/{1}) for detailed changes.', github.repository, steps.version.outputs.tag) }}

            ---

            ğŸ› If you find issues or have feature requests, please [submit an Issue](https://github.com/MonchiLin/antigravity-agent/issues/new)
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Step 2: å¹¶è¡Œæ„å»ºå’Œä¸Šä¼ 
  build:
    needs: prepare-release
    uses: ./.github/workflows/tauri-build.yml
    with:
      tag: ${{ needs.prepare-release.outputs.tag }}
      ref: ${{ github.ref }}
      version: ${{ needs.prepare-release.outputs.version }}
      cache_key_suffix: release
    secrets: inherit

  # Step 3: Trigger updater
  trigger-updater:
    needs: [prepare-release, build]
    runs-on: ubuntu-latest
    if: success()
    steps:
      - name: Generate updater configuration
        uses: peter-evans/repository-dispatch@v2
        with:
          event-type: generate-updater
          client-payload: '{"tag": "${{ needs.prepare-release.outputs.tag }}"}'
