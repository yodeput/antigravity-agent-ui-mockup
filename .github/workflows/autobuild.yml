name: AutoBuild

on:
  push:
    branches: [dev] # Trigger on dev branch push
  schedule:
    - cron: "0 0 * * *" # Build Nightly once daily at 00:00 UTC
  workflow_dispatch: # Manual trigger

permissions:
  contents: write # Allow creating/updating releases, uploading files

concurrency:
  group: autobuild-${{ github.ref }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always

jobs:
  # Step 1: Delete old release, create new release
  prepare-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout dev branch
        uses: actions/checkout@v4
        with:
          ref: dev

      - name: Delete old autobuild release (if exists)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Try to delete old release
          gh release delete autobuild --yes --repo "${{ github.repository }}" 2>/dev/null || echo "No existing release to delete"
          # Try to delete old tag
          gh api -X DELETE "repos/${{ github.repository }}/git/refs/tags/autobuild" 2>/dev/null || echo "No existing tag to delete"
          echo "âœ… Cleaned up old release and tag"

      - name: Create new autobuild release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: autobuild
          name: "Antigravity Agent Nightly (${{ github.event.head_commit.timestamp }})"
          body: |
            Nightly build from dev branch.

            ğŸ• Last updated: ${{ github.event.head_commit.timestamp }}
            ğŸ“¦ Commit: ${{ github.sha }}

            ---
            ## ğŸ“¥ Download

            âš ï¸ **Note**: This is an automated test build and may be unstable. Regular users should use the [stable release](https://github.com/MonchiLin/antigravity-agent/releases/latest).

            ### Windows
            - **Installer** (Recommended): [Antigravity.Agent_x64-setup.exe](${{ github.server_url }}/${{ github.repository }}/releases/download/autobuild/Antigravity.Agent_x64-setup.exe) - Supports auto-update
            - **Portable**: [Antigravity-Agent-x86_64-Portable.zip](${{ github.server_url }}/${{ github.repository }}/releases/download/autobuild/Antigravity-Agent-x86_64-Portable.zip) - Extract and run, no installation required

            ### macOS
            - **Apple Silicon (M1/M2)**: [Antigravity.Agent_aarch64.dmg](${{ github.server_url }}/${{ github.repository }}/releases/download/autobuild/Antigravity.Agent_aarch64.dmg)
            - **Intel Mac**: [Antigravity.Agent_x86_64.dmg](${{ github.server_url }}/${{ github.repository }}/releases/download/autobuild/Antigravity.Agent_x86_64.dmg)

            ### Linux
            - **AppImage**: [antigravity-agent_amd64.AppImage](${{ github.server_url }}/${{ github.repository }}/releases/download/autobuild/antigravity-agent_amd64.AppImage) - Universal format, works on all distros
            - **Debian/Ubuntu**: [antigravity-agent_amd64.deb](${{ github.server_url }}/${{ github.repository }}/releases/download/autobuild/antigravity-agent_amd64.deb)
            ---

            ğŸ› If you find issues or have feature requests, please [submit an Issue](https://github.com/MonchiLin/antigravity-agent/issues/new)
          prerelease: true
          draft: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Step 2: Parallel build
  build:
    needs: prepare-release
    uses: ./.github/workflows/tauri-build.yml
    with:
      tag: autobuild
      ref: dev
      cache_key_suffix: autobuild
    secrets: inherit
